
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/blogs/plot_emg_pose.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_blogs_plot_emg_pose.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_blogs_plot_emg_pose.py:


Predict hand pose from EMG signals using ML
===========================================

Meta has been doing a lot of work trying to figure out how to replace
keyboards and controllers with hand gestures (when the user is wearing
a wrist band). 

Back when I was a young hopper (AKA a PhD student), I interviewed with
their Reality Labs team. The technical interview at the time was to
take a dataset of EMG signals from a participant, and to predict the
hand pose of the participant (Also, nearly pure python.. I.e. no
scikit-learn, no pytorch. Woof).

Well now they've open-sourced the EMG dataset from that project, so
I am going to save some soul out there some time and show how them
how to do it.

.. GENERATED FROM PYTHON SOURCE LINES 22-37

.. code-block:: Python

    from collections.abc import KeysView
    from dataclasses import dataclass
    from pathlib import Path
    from typing import Any, ClassVar

    import h5py
    import matplotlib.pyplot as plt
    import mne
    import numpy as np
    import pooch
    import seaborn as sns
    from sklearn.cluster import KMeans
    from sklearn.decomposition import PCA









.. GENERATED FROM PYTHON SOURCE LINES 38-41

Create a helper function to read the data
------------------------------------------------


.. GENERATED FROM PYTHON SOURCE LINES 43-153

.. code-block:: Python

    @dataclass
    class Emg2PoseSessionData:
        """A read-only interface to a single emg2pose session file stored in
        HDF5 format.

        ``self.timeseries`` is a `h5py.Dataset` instance with a compound data type
        as in a numpy structured array containing three fields - EMG data from the
        left and right wrists, and their corresponding timestamps.
        The sampling rate of EMG is 2kHz, each EMG device has 16 electrode
        channels, and the signal has been high-pass filtered. Therefore, the fields
        corresponding to left and right EMG are 2D arrays of shape ``(T, 16)`` each
        and ``timestamps`` is a 1D array of length ``T``.

        NOTE: Only the metadata and ground-truth are loaded into memory while the
        EMG data is accesssed directly from disk. When wrapping this interface
        within a PyTorch Dataset, use multiple dataloading workers to mask the
        disk seek and read latencies."""

        HDF5_GROUP: ClassVar[str] = "emg2pose"
        # timeseries keys
        TIMESERIES: ClassVar[str] = "timeseries"
        EMG: ClassVar[str] = "emg"
        JOINT_ANGLES: ClassVar[str] = "joint_angles"
        TIMESTAMPS: ClassVar[str] = "time"
        # metadata keys
        SESSION_NAME: ClassVar[str] = "session"
        SIDE: ClassVar[str] = "side"
        STAGE: ClassVar[str] = "stage"
        START_TIME: ClassVar[str] = "start"
        END_TIME: ClassVar[str] = "end"
        NUM_CHANNELS: ClassVar[str] = "num_channels"
        DATASET_NAME: ClassVar[str] = "dataset"
        USER: ClassVar[str] = "user"
        SAMPLE_RATE: ClassVar[str] = "sample_rate"

        hdf5_path: Path

        def __post_init__(self) -> None:
            self._file = h5py.File(self.hdf5_path, "r")
            emg2pose_group: h5py.Group = self._file[self.HDF5_GROUP]

            # ``timeseries`` is a HDF5 compound Dataset
            self.timeseries: h5py.Dataset = emg2pose_group[self.TIMESERIES]
            assert self.timeseries.dtype.fields is not None
            assert self.EMG in self.timeseries.dtype.fields
            assert self.JOINT_ANGLES in self.timeseries.dtype.fields
            assert self.TIMESTAMPS in self.timeseries.dtype.fields

            # Load the metadata entirely into memory as it's rather small
            self.metadata: dict[str, Any] = {}
            for key, val in emg2pose_group.attrs.items():
                self.metadata[key] = val

        def __enter__(self):
            return self

        def __exit__(self, exc_type, exc_value, traceback) -> None:
            self._file.close()

        def __len__(self) -> int:
            return len(self.timeseries)

        def __getitem__(self, key: slice) -> np.ndarray:
            return self.timeseries[key]

        def slice(self, start_t: float = -np.inf, end_t: float = np.inf) -> np.ndarray:
            """Load and return a contiguous slice of the timeseries windowed
            by the provided start and end timestamps.

            Args:
                start_t (float): The start time of the window to grab
                    (in absolute unix time). Defaults to selecting from the
                    beginning of the session. (default: ``-np.inf``).
                end_t (float): The end time of the window to grab
                    (in absolute unix time). Defaults to selecting until the
                    end of the session. (default: ``np.inf``)
            """
            start_idx, end_idx = self.timestamps.searchsorted([start_t, end_t])
            return self[start_idx:end_idx]

        @property
        def fields(self) -> KeysView[str]:
            """The names of the fields in ``timeseries``."""
            fields: KeysView[str] = self.timeseries.dtype.fields.keys()
            return fields

        @property
        def timestamps(self) -> np.ndarray:
            """EMG timestamps.

            NOTE: This reads the entire sequence of timesetamps from the underlying
            HDF5 file and therefore incurs disk latency. Avoid this in the critical
            path."""
            emg_timestamps = self.timeseries[self.TIMESTAMPS]
            assert (np.diff(emg_timestamps) >= 0).all(), "Not monotonic"
            return emg_timestamps

        @property
        def session_name(self) -> str:
            """Unique name of the session."""
            return self.metadata[self.SESSION_NAME]

        @property
        def user(self) -> str:
            """Unique ID of the user this session corresponds to."""
            return self.metadata[self.USER]

        def __str__(self) -> str:
            return f"{self.__class__.__name__} {self.session_name} ({len(self)} samples)"








.. GENERATED FROM PYTHON SOURCE LINES 154-157

Download the dataset
--------------------


.. GENERATED FROM PYTHON SOURCE LINES 159-178

.. code-block:: Python

    data_dir = Path.home() / "emg_data"
    emg_dir = data_dir / "emg2pose_dataset_mini"
    want_fpath = "emg2pose_dataset_mini/2022-12-06-1670313600-e3096-cv-emg-pose-train@2-recording-1_left.hdf5"

    unpack = pooch.Untar(extract_dir=data_dir, # Relative to the path where the zip file is downloaded
                         members=[want_fpath]
                         )
    emg_fpaths = pooch.retrieve(
        url="https://fb-ctrl-oss.s3.amazonaws.com/emg2pose/emg2pose_dataset_mini.tar",
        known_hash="sha256:d7400e98508ccbb2139c2d78e552867b23501f637456546fd6680f3fe7fec50d",
        progressbar=True,
        path=data_dir,
        processor=unpack,
    )
    emg_fname = Path(emg_fpaths[0])
    emg_dir = emg_fname.parent
    # Delete the large tar file
    list(data_dir.glob("*.tar"))[0].unlink()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|                                               | 0.00/647M [00:00<?, ?B/s]      1%|▍                                     | 8.38M/647M [00:00<00:13, 48.0MB/s]      2%|▉                                     | 15.0M/647M [00:00<00:31, 19.9MB/s]      3%|█                                     | 17.7M/647M [00:00<00:29, 21.0MB/s]      4%|█▎                                    | 23.4M/647M [00:00<00:24, 25.0MB/s]      4%|█▌                                    | 27.0M/647M [00:01<00:22, 27.2MB/s]      5%|█▉                                    | 33.5M/647M [00:01<00:18, 32.4MB/s]      6%|██▍                                   | 41.3M/647M [00:01<00:14, 42.6MB/s]      7%|██▋                                   | 46.2M/647M [00:01<00:16, 37.4MB/s]      8%|██▉                                   | 50.5M/647M [00:01<00:20, 28.6MB/s]      9%|███▎                                  | 56.4M/647M [00:01<00:17, 34.5MB/s]      9%|███▌                                  | 60.6M/647M [00:02<00:24, 23.7MB/s]     10%|███▉                                  | 67.1M/647M [00:02<00:20, 28.9MB/s]     11%|████▎                                 | 74.1M/647M [00:02<00:19, 28.7MB/s]     12%|████▌                                 | 77.6M/647M [00:02<00:21, 27.0MB/s]     12%|████▋                                 | 80.7M/647M [00:02<00:22, 25.0MB/s]     13%|████▉                                 | 83.9M/647M [00:02<00:22, 25.2MB/s]     14%|█████▎                                | 90.5M/647M [00:03<00:17, 31.0MB/s]     14%|█████▌                                | 93.8M/647M [00:03<00:22, 24.6MB/s]     16%|██████                                 | 101M/647M [00:03<00:19, 28.5MB/s]     17%|██████▍                                | 107M/647M [00:03<00:19, 27.2MB/s]     17%|██████▋                                | 110M/647M [00:03<00:20, 26.5MB/s]     18%|███████                                | 117M/647M [00:04<00:16, 32.8MB/s]     19%|███████▍                               | 124M/647M [00:04<00:16, 32.3MB/s]     20%|███████▋                               | 127M/647M [00:04<00:18, 27.6MB/s]     21%|████████                               | 134M/647M [00:04<00:16, 31.7MB/s]     22%|████████▍                              | 141M/647M [00:04<00:13, 36.6MB/s]     22%|████████▋                              | 145M/647M [00:04<00:14, 34.5MB/s]     23%|█████████                              | 150M/647M [00:05<00:13, 37.6MB/s]     24%|█████████▎                             | 154M/647M [00:05<00:13, 35.9MB/s]     25%|█████████▌                             | 160M/647M [00:05<00:11, 42.0MB/s]     26%|█████████▉                             | 165M/647M [00:05<00:10, 45.8MB/s]     26%|██████████▎                            | 170M/647M [00:05<00:14, 33.8MB/s]     27%|██████████▍                            | 174M/647M [00:05<00:15, 30.6MB/s]     27%|██████████▋                            | 178M/647M [00:05<00:16, 28.6MB/s]     29%|███████████                            | 185M/647M [00:06<00:13, 35.4MB/s]     30%|███████████▌                           | 191M/647M [00:06<00:10, 43.0MB/s]     30%|███████████▊                           | 196M/647M [00:06<00:12, 36.1MB/s]     31%|████████████                           | 200M/647M [00:06<00:16, 27.6MB/s]     31%|████████████▎                          | 204M/647M [00:06<00:15, 28.2MB/s]     32%|████████████▌                          | 209M/647M [00:06<00:12, 34.2MB/s]     33%|████████████▉                          | 215M/647M [00:06<00:10, 39.5MB/s]     34%|█████████████▏                         | 220M/647M [00:07<00:11, 37.0MB/s]     35%|█████████████▋                         | 226M/647M [00:07<00:11, 37.8MB/s]     36%|██████████████▏                        | 235M/647M [00:07<00:11, 35.7MB/s]     38%|██████████████▋                        | 243M/647M [00:07<00:11, 34.7MB/s]     39%|███████████████                        | 250M/647M [00:08<00:13, 29.3MB/s]     39%|███████████████▎                       | 253M/647M [00:08<00:14, 27.8MB/s]     40%|███████████████▌                       | 259M/647M [00:08<00:14, 27.2MB/s]     40%|███████████████▊                       | 261M/647M [00:08<00:15, 24.2MB/s]     41%|████████████████▏                      | 268M/647M [00:08<00:11, 31.6MB/s]     42%|████████████████▍                      | 272M/647M [00:08<00:12, 29.7MB/s]     43%|████████████████▋                      | 277M/647M [00:09<00:14, 25.1MB/s]     44%|█████████████████▏                     | 285M/647M [00:09<00:10, 33.6MB/s]     45%|█████████████████▌                     | 292M/647M [00:09<00:11, 30.1MB/s]     46%|█████████████████▊                     | 295M/647M [00:09<00:12, 29.2MB/s]     46%|██████████████████                     | 300M/647M [00:09<00:10, 33.5MB/s]     47%|██████████████████▎                    | 304M/647M [00:09<00:10, 31.3MB/s]     48%|██████████████████▌                    | 309M/647M [00:10<00:12, 27.9MB/s]     48%|██████████████████▊                    | 312M/647M [00:10<00:12, 27.8MB/s]     49%|███████████████████▏                   | 319M/647M [00:10<00:10, 31.5MB/s]     50%|███████████████████▌                   | 325M/647M [00:10<00:08, 37.0MB/s]     51%|███████████████████▊                   | 329M/647M [00:10<00:09, 34.6MB/s]     52%|████████████████████▏                  | 336M/647M [00:10<00:08, 35.5MB/s]     53%|████████████████████▌                  | 342M/647M [00:10<00:07, 40.9MB/s]     54%|████████████████████▊                  | 346M/647M [00:11<00:07, 38.9MB/s]     54%|█████████████████████▏                 | 351M/647M [00:11<00:07, 38.1MB/s]     55%|█████████████████████▍                 | 355M/647M [00:11<00:09, 29.4MB/s]     56%|█████████████████████▋                 | 361M/647M [00:11<00:08, 33.3MB/s]     57%|██████████████████████▏                | 368M/647M [00:11<00:07, 35.1MB/s]     57%|██████████████████████▍                | 372M/647M [00:11<00:08, 32.2MB/s]     58%|██████████████████████▋                | 376M/647M [00:11<00:08, 33.4MB/s]     59%|██████████████████████▊                | 379M/647M [00:12<00:08, 30.9MB/s]     60%|███████████████████████▏               | 385M/647M [00:12<00:06, 37.8MB/s]     60%|███████████████████████▍               | 389M/647M [00:12<00:07, 36.4MB/s]     61%|███████████████████████▊               | 394M/647M [00:12<00:08, 30.7MB/s]     62%|████████████████████████▏              | 401M/647M [00:12<00:10, 23.4MB/s]     62%|████████████████████████▎              | 404M/647M [00:13<00:12, 19.9MB/s]     63%|████████████████████████▋              | 409M/647M [00:13<00:14, 16.7MB/s]     64%|████████████████████████▊              | 411M/647M [00:13<00:14, 16.5MB/s]     65%|█████████████████████████▏             | 418M/647M [00:13<00:10, 21.3MB/s]     65%|█████████████████████████▎             | 420M/647M [00:14<00:12, 18.5MB/s]     66%|█████████████████████████▊             | 428M/647M [00:14<00:08, 24.9MB/s]     67%|██████████████████████████▏            | 434M/647M [00:14<00:07, 28.6MB/s]     68%|██████████████████████████▎            | 438M/647M [00:14<00:07, 26.3MB/s]     68%|██████████████████████████▋            | 443M/647M [00:14<00:07, 28.9MB/s]     69%|██████████████████████████▊            | 446M/647M [00:14<00:07, 28.0MB/s]     70%|███████████████████████████▏           | 452M/647M [00:14<00:05, 34.4MB/s]     70%|███████████████████████████▍           | 455M/647M [00:15<00:06, 31.7MB/s]     71%|███████████████████████████▊           | 461M/647M [00:15<00:06, 30.8MB/s]     72%|████████████████████████████▏          | 468M/647M [00:15<00:05, 34.9MB/s]     73%|████████████████████████████▍          | 472M/647M [00:15<00:05, 31.6MB/s]     74%|████████████████████████████▊          | 478M/647M [00:15<00:05, 33.0MB/s]     75%|█████████████████████████████▏         | 485M/647M [00:15<00:04, 37.2MB/s]     75%|█████████████████████████████▍         | 489M/647M [00:16<00:04, 35.0MB/s]     76%|█████████████████████████████▋         | 493M/647M [00:16<00:04, 34.8MB/s]     77%|█████████████████████████████▉         | 497M/647M [00:16<00:04, 32.5MB/s]     78%|██████████████████████████████▎        | 503M/647M [00:16<00:04, 34.6MB/s]     79%|██████████████████████████████▋        | 510M/647M [00:16<00:04, 32.5MB/s]     79%|██████████████████████████████▉        | 513M/647M [00:16<00:04, 31.7MB/s]     80%|███████████████████████████████▎       | 520M/647M [00:17<00:03, 32.8MB/s]     81%|███████████████████████████████▋       | 527M/647M [00:17<00:03, 38.6MB/s]     82%|███████████████████████████████▉       | 531M/647M [00:17<00:03, 34.5MB/s]     83%|████████████████████████████████▏      | 535M/647M [00:17<00:03, 35.6MB/s]     83%|████████████████████████████████▍      | 539M/647M [00:17<00:03, 33.1MB/s]     84%|████████████████████████████████▊      | 545M/647M [00:17<00:03, 32.8MB/s]     85%|█████████████████████████████████▎     | 552M/647M [00:17<00:02, 35.7MB/s]     86%|█████████████████████████████████▍     | 555M/647M [00:18<00:02, 30.8MB/s]     87%|█████████████████████████████████▊     | 561M/647M [00:18<00:02, 34.9MB/s]     87%|██████████████████████████████████     | 564M/647M [00:18<00:02, 35.0MB/s]     88%|██████████████████████████████████▎    | 569M/647M [00:18<00:02, 29.7MB/s]     88%|██████████████████████████████████▍    | 572M/647M [00:18<00:02, 25.9MB/s]     89%|██████████████████████████████████▊    | 577M/647M [00:18<00:02, 27.3MB/s]     90%|██████████████████████████████████▉    | 580M/647M [00:18<00:02, 26.5MB/s]     91%|███████████████████████████████████▎   | 586M/647M [00:19<00:01, 35.2MB/s]     91%|███████████████████████████████████▌   | 590M/647M [00:19<00:01, 33.6MB/s]     92%|███████████████████████████████████▊   | 594M/647M [00:19<00:01, 27.3MB/s]     92%|███████████████████████████████████▉   | 597M/647M [00:19<00:01, 26.7MB/s]     93%|████████████████████████████████████▎  | 603M/647M [00:19<00:01, 33.7MB/s]     94%|████████████████████████████████████▌  | 606M/647M [00:19<00:01, 32.2MB/s]     95%|████████████████████████████████████▉  | 612M/647M [00:19<00:01, 31.0MB/s]     96%|█████████████████████████████████████▎ | 619M/647M [00:20<00:00, 37.3MB/s]     96%|█████████████████████████████████████▌ | 623M/647M [00:20<00:00, 37.3MB/s]     97%|█████████████████████████████████████▊ | 628M/647M [00:20<00:00, 39.9MB/s]     98%|██████████████████████████████████████ | 632M/647M [00:20<00:00, 38.7MB/s]     98%|██████████████████████████████████████▍| 637M/647M [00:20<00:00, 41.4MB/s]     99%|██████████████████████████████████████▋| 641M/647M [00:20<00:00, 39.8MB/s]    100%|██████████████████████████████████████▉| 645M/647M [00:20<00:00, 36.3MB/s]      0%|                                               | 0.00/647M [00:00<?, ?B/s]    100%|███████████████████████████████████████| 647M/647M [00:00<00:00, 2.01TB/s]




.. GENERATED FROM PYTHON SOURCE LINES 179-182

Load the data
----------------


.. GENERATED FROM PYTHON SOURCE LINES 184-186

.. code-block:: Python

    data = Emg2PoseSessionData(hdf5_path=emg_fname)








.. GENERATED FROM PYTHON SOURCE LINES 187-190

Visualize the data
------------------
We'll let MNE-Python do the heavy lifting for us here.

.. GENERATED FROM PYTHON SOURCE LINES 192-202

.. code-block:: Python

    ch_names = [f"EMG{ii:02}" for ii, _ in enumerate(data["emg"].T, 1)]
    ch_types = ["emg"] * len(ch_names)
    sfreq = data.metadata[Emg2PoseSessionData.SAMPLE_RATE]
    info = mne.create_info(ch_names=ch_names, ch_types=ch_types, sfreq=sfreq)
    # MNE expects data in the shape (n_channels, n_times). So we need to transpose the data
    raw = mne.io.RawArray(data["emg"].T, info)
    # MNE expects the EMG data to be in Volts, so we need to scale it from mV to V
    raw.apply_function(lambda x: x * 1e-6, picks="emg")
    raw.plot(start=20, duration=20)




.. image-sg:: /auto_examples/blogs/images/sphx_glr_plot_emg_pose_001.png
   :alt: plot emg pose
   :srcset: /auto_examples/blogs/images/sphx_glr_plot_emg_pose_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Creating RawArray with float64 data, n_channels=16, n_times=142674
        Range : 0 ... 142673 =      0.000 ...    71.337 secs
    Ready.
    Using matplotlib as 2D backend.

    <MNEBrowseFigure size 800x800 with 4 Axes>



.. GENERATED FROM PYTHON SOURCE LINES 203-209

Use PCA and KMeans to cluster the data
--------------------------------------

We'll use PCA to reduce the data dimenstionality to 3D
and then use KMeans to cluster the data.


.. GENERATED FROM PYTHON SOURCE LINES 211-216

.. code-block:: Python

    n_components = 3
    pca = PCA(n_components=n_components)
    data_pca = pca.fit_transform(data["emg"])
    clusters = KMeans(n_clusters=5).fit_predict(data_pca)








.. GENERATED FROM PYTHON SOURCE LINES 217-220

Visualize the clusters
----------------------


.. GENERATED FROM PYTHON SOURCE LINES 222-232

.. code-block:: Python

    sns.set_theme(style="darkgrid")
    fig, ax = plt.subplots(subplot_kw={"projection": "3d"})
    ax.scatter(data_pca[:, 0], data_pca[:, 1], data_pca[:, 2], c=clusters)
    ax.set_xlabel("PC1")
    ax.set_ylabel("PC2")
    ax.set_zlabel("PC3")
    ax.set_title("PCA of EMG data with KMeans clustering")
    plt.show()





.. image-sg:: /auto_examples/blogs/images/sphx_glr_plot_emg_pose_002.png
   :alt: PCA of EMG data with KMeans clustering
   :srcset: /auto_examples/blogs/images/sphx_glr_plot_emg_pose_002.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 28.444 seconds)


.. _sphx_glr_download_auto_examples_blogs_plot_emg_pose.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_emg_pose.ipynb <plot_emg_pose.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_emg_pose.py <plot_emg_pose.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_emg_pose.zip <plot_emg_pose.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
